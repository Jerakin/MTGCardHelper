<!doctype html>
<!--
/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
* Copyright 2020 Adobe
* All Rights Reserved.
*
* NOTICE: Adobe permits you to use, modify, and distribute this file in
* accordance with the terms of the Adobe license agreement accompanying
* it. If you have received this file from a source other than Adobe,
* then your use, modification, or distribution of it requires the prior
* written permission of Adobe. 
**************************************************************************/
-->
<html>
<title>PProPanel</title>
<head>
	<meta charset="utf-8">
	<script src="./ext.js"></script>
	<script src="./lib/CSInterface.js"></script>
<!--	<script src="./lib/jquery-1.9.1.js"></script>-->
<!--	<script src="./lib/jquery-1.12.4.js"></script>-->
		<script src="./lib/jquery-3.6.0.js"></script>
	<script src="./lib/Vulcan.js"></script>
	<script src="./lib/bootstrap.bundle.min.js"></script>
	<link id="bootstrap" href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link id="style" href="css/style.css" rel="stylesheet" type="text/css">
	<script type="text/javascript">
		$(document).ready(function () {
			const $myInput = document.getElementById('card-search');
			let typing_timer;
			let selected_index = -1;
			let latest_data = {}
			let active_list_type = ""
			console.log("[DEBUG] : " + "Extension Start")

			importSettingsJson(function(data){
				const p_group = $("#properties-group");
				$.each(data, function(index, element){
					p_group.append(get_property_group(Date.now(), element.track, element.scale, element.x, element.y));
				})
			});

			function get_property_group(id, track, scale, x, y){
				return`
<div class="p-2 border-start border-1 border-dark border-opacity-10" id="properties-${id}" data-id="${id}">
	<label for="track-${id}" class="d-none">Track</label>
	<div class="row">
		<div class="input-group mb-2 mr-sm-2 col">
			<div class="input-group-prepend">
				<div class="input-group-text">Track</div>
			</div>
			<input type="number" class="form-control" id="track-${id}" value="${track}">
		</div>
		<button class="close-setting btn btn-close col-1" data-id="properties-${id}"></button>
	</div>
	<label for="scale-${id}" class="d-none">Scale</label>
	<div class="input-group mb-2 mr-sm-2">
		<div class="input-group-prepend">
			<div class="input-group-text">Scale</div>
		</div>
		<input type="text" class="form-control" id="scale-${id}" onkeypress="return (event.charCode>=45 && event.charCode<=57)" value="${scale}">
	</div>

	<div class="row">
		<label for="pos-x-${id}" class="d-none">PosX</label>
		<div class="input-group mb-2 mr-sm-2 col">
			<div class="input-group-prepend">
				<div class="input-group-text">Pos X</div>
			</div>
			<input type="text" class="form-control" id="pos-x-${id}" onkeypress="return (event.charCode>=45 && event.charCode<=57)" value="${x}">
		</div>
		<label for="pos-x-${id}" class="d-none">PosY</label>
		<div class="input-group mb-2 mr-sm-2 col">
			<div class="input-group-prepend">
				<div class="input-group-text">Pos Y</div>
			</div>
			<input type="text" class="form-control" id="pos-y-${id}" onkeypress="return (event.charCode>=45 && event.charCode<=57)" value="${y}">
		</div>
	</div>
</div>
`
			}
			
			function update_card_list () {
				if ($myInput.value.length >= 3) {
					show_list("card-list-result", true)
					active_list_type = "card-list-result"
					$("#card-list-result").empty()
					const get_call = $.get("https://api.scryfall.com/cards/search?q=" + $myInput.value);
					get_call.done(function (data) {
						latest_data = data;
						$.each(data["data"], function (index, element) {
							const list_element = `
<div class='d-flex justify-content-between list-group-item list-group-item-action'>
	<a class='mtg-card text-decoration-none text-dark align-self-start w-100 d-block' href='#'>${element["name"]}</a>
	<img class="mtg-card img-fluid h-100" src="assets/files.png" alt="SET" data-print-search-uri="${element["prints_search_uri"]}">
</div>
`
							$("#card-list-result").append(list_element)
						});
					});
				} else {
					show_list("-", false)
				}
			}

			function update_image_view(uri){
				const get_call = $.get(uri);
				get_call.done(function (data) {
					$.each(data["data"], function (index, element) {
						const list_element = `

	<img class="set-card-img col" src="${element["image_uris"]["small"]}" alt="SET" data-card-uri="${element["image_uris"]["png"]}" data-card-name="${element["name"]}">

`
						$("#card-image-result").append(list_element)
					});
				});
			}

			function show_list(name, toggle) {
				if (name === "card-list-result"){
					if (toggle) {
						$("#card-list-result").removeClass("d-none");
						$("#card-image-result").addClass("d-none");
						$("#parent-result").removeClass("d-none");
						$("#properties-group").addClass("d-none");
						$("#add-track-setting").addClass("d-none");
					}
				} else {
					if (toggle) {
						$("#card-image-result").removeClass("d-none");
						$("#card-list-result").addClass("d-none");
						$("#parent-result").removeClass("d-none");
						$("#properties-group").addClass("d-none");
						$("#add-track-setting").addClass("d-none");
					}
				}
				if (!toggle) {
					$("#card-list-result").addClass("d-none");
					$("#card-image-result").addClass("d-none");
					$("#parent-result").addClass("d-none");
					$("#properties-group").removeClass("d-none");
					$("#add-track-setting").removeClass("d-none");
				}
			}

			function collect_track_properties(){
				let prop = []
				console.log("[DEBUG] : " + "Start Collection")
				const p_group = $("#properties-group");
				const children = p_group.children();
				for (var i = 0; i < children.length; i++) {
					const properties_id = jQuery(children[i]).data("id");

					let p = {}
					p.scale = document.getElementById('scale-'+ properties_id).value;
					p.track = document.getElementById('track-'+ properties_id).value;
					p.x = document.getElementById('pos-x-'+ properties_id).value;
					p.y = document.getElementById('pos-y-'+ properties_id).value;

					p.scale = p.scale && parseFloat(p.scale)
					p.track = p.track && parseInt(p.track)
					p.x = p.x && parseFloat(p.x)
					p.y = p.y && parseFloat(p.y)
					prop.push(p)
				}
				return prop
			}

			// Add Track Setting
			$(document).on("click", "#add-track-setting", function(event){
				const p_group = $("#properties-group");
				p_group.append(get_property_group(Date.now(), "", 100, 640, 360));
			});

			// Remove Track Setting
			$(document).on("click", "button.close-setting", function(event){
				const properties_id = jQuery(this).data("id");
				$("#"+properties_id).remove();
			});

			// List entry click
			$(document).on("click", "a.mtg-card", function(event){
				if (latest_data){
					console.log("[DEBUG] : " + "Download from list")
					const this_name = jQuery(this).text();
					$.each(latest_data["data"], function(index, element){
						if (element["name"] === this_name) {
							const url = element["image_uris"]["png"];
							const props = {url:url, name:this_name, overwrite:false, tracks: collect_track_properties()}
							downloadAndImport(props)
						}
					});
				}
			});

			// Button to find all versions of a card
			$(document).on("click", "img.mtg-card", function(event){
				console.log("[DEBUG] : " + "Update Version View")
				show_list("card-image-result", true)
				$("#card-image-result").empty()
				active_list_type = "card-image-result"
				const this_uri = jQuery(this).data("print-search-uri");
				update_image_view(this_uri);
			});

			// Big cards
			$(document).on("click", "img.set-card-img", function(event){
				console.log("[DEBUG] : " + "Download from image")
				active_list_type = "card-image-result"
				const url = jQuery(this).data("card-uri");
				const card_name = jQuery(this).data("card-name");
				const props = {url:url, name:card_name, overwrite:true, tracks: collect_track_properties()}
				downloadAndImport(props)
			});

			// Dropdown list navigation visualiser
			const set_active = function(index){
				const children = $('#card-list-result').children();
				for (var i = 0; i < children.length; i++) {
					const child = $(children[i]);
					child.removeClass("active");
					if (i === index) {
						child.addClass("active");
					}
				}
			}

			$('#card-search').on("focus", function(){
				if ($('#card-list-result').children().length !== 0) {
					if (active_list_type) {
						show_list(active_list_type, true)
					} else {
						show_list("-", false)
					}
				}
			})
			.on("focusout", function(){
				setTimeout(function() {
					show_list("-", false)
					if (selected_index !== -1) {
						selected_index = -1;
						set_active(selected_index)
					}
				}, 150)
			});

			$myInput.onkeydown = function(event){
				if (event.key === 'ArrowUp') {
					event.preventDefault();
					selected_index = Math.max(selected_index-1, -1);
					set_active(selected_index)
				}
				else if (event.key === 'ArrowDown') {
					event.preventDefault();
					const num_children = $('#card-list-result').children().length
					selected_index = Math.min(selected_index+1, num_children-1);
					set_active(selected_index)
				}
				else if (event.key === 'Enter') {
					if ($myInput.value.length >= 3) {
						console.log("[DEBUG] : " + "Download from enter key")
						if (selected_index === -1) {
							const element = latest_data["data"][0]
							const url = element["image_uris"]["png"];
							const props = {url:url, name:element["name"], overwrite:false, tracks:  collect_track_properties()}
							downloadAndImport(props)
						} else {
							const element = latest_data["data"][selected_index]
							const url = element["image_uris"]["png"];
							const props = {url:url, name:element["name"], overwrite:false, tracks:  collect_track_properties()}
							downloadAndImport(props)
						}
					}
				else {
						clearTimeout(typing_timer);
					}
				}

				$myInput.onkeyup = function(event) {
					if (event.key === "Backspace" || (event.key.length === 1 && (event.key >= "A" && event.key <= "Z") || (event.key >= "a" && event.key <= "z"))) {
						selected_index = -1;
						clearTimeout(typing_timer);
						typing_timer = setTimeout(update_card_list, 200);
					}
				}
			}
		});
	</script>
</head>

<body class="d-flex flex-column min-vh-100" onLoad="onLoaded()" oncontextmenu="return false;">
	<div class="container d-flex flex-column">
		<header class="p-2 m-2">
			<a class="text-decoration-none text-dark h1" href="javascript:history.go(0)">
				MTG Card Helper
			</a>
		</header>
		<div class="p-2 form-group w-100">
			<label class="form-label" for="card-search">Search</label>
			<input class="form-control" type="text" id="card-search" name="card-search">
		</div>
		<div id="parent-result" class="p-2 result-list w-100 d-none">
			<div id="card-list-result" class="list-group d-none overflow-auto h-100"></div>
			<div id="card-image-result" class="d-none overflow-auto me-0 h-100 row row-cols-3"></div>
		</div>
		<div class="p-2" id="properties-group">
		</div>
		<footer class="fixed-bottom">
			<div>Created by <a href="https://github.com/Jerakin" target="_blank">Jerakin</a>
				| Powered by <a href="https://www.scryfall.com/" target="_">Scryfall</a></div>
		</footer>
		<button id="add-track-setting" class="btn btn-primary w-75 shadow-none m-auto mb-5">Add Track Setting</button>
	</div>
</body>
<script>
	document.body.onbeforeunload = function () {
		function collect_track_properties(){
			let prop = []
			console.log("[DEBUG] : " + "Start Collection")
			const p_group = $("#properties-group");
			const children = p_group.children();
			for (var i = 0; i < children.length; i++) {
				const properties_id = jQuery(children[i]).data("id");

				let p = {}
				p.scale = document.getElementById('scale-'+ properties_id).value;
				p.track = document.getElementById('track-'+ properties_id).value;
				p.x = document.getElementById('pos-x-'+ properties_id).value;
				p.y = document.getElementById('pos-y-'+ properties_id).value;

				p.scale = p.scale && parseFloat(p.scale)
				p.track = p.track && parseInt(p.track)
				p.x = p.x && parseFloat(p.x)
				p.y = p.y && parseFloat(p.y)
				prop.push(p)
			}
			return prop
		}
		const track_data = collect_track_properties()
		exportSettingsJson(track_data)
	};
</script>

</html>
