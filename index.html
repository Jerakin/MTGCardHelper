<!doctype html>
<!--
/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
* Copyright 2020 Adobe
* All Rights Reserved.
*
* NOTICE: Adobe permits you to use, modify, and distribute this file in
* accordance with the terms of the Adobe license agreement accompanying
* it. If you have received this file from a source other than Adobe,
* then your use, modification, or distribution of it requires the prior
* written permission of Adobe. 
**************************************************************************/
-->
<html>
<title>PProPanel</title>
<head>
	<meta charset="utf-8">
	<script src="./ext.js"></script>
	<script src="./lib/CSInterface.js"></script>
<!--	<script src="./lib/jquery-1.9.1.js"></script>-->
<!--	<script src="./lib/jquery-1.12.4.js"></script>-->
		<script src="./lib/jquery-3.6.0.js"></script>
	<script src="./lib/Vulcan.js"></script>
	<script src="./lib/bootstrap.bundle.min.js"></script>
	<link id="bootstrap" href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link id="style" href="css/style.css" rel="stylesheet" type="text/css">
	<script type="text/javascript">
		$(document).ready(function () {
			const $myInput = document.getElementById('card-search');
			let typing_timer;
			let selected_index = -1;
			let latest_data = {}
			$(document).on("click", "a.mtg-card", function(event){
				if (latest_data){
					const $scale = document.getElementById('scale');
					const this_name = jQuery(this).text();
					$.each(latest_data["data"], function(index, element){
						if (element["name"] === this_name) {
							const url = element["image_uris"]["png"];
							downloadAndImport(url, this_name + ".png", ($scale.value || 100))
						}
					});
				}
			});

			const set_active = function(index){
				const children = $('#search-result').children();
				for (var i = 0; i < children.length; i++) {
					const child = $(children[i]);
					child.removeClass("active");
					if (i === index) {
						child.addClass("active");
					}
				}
			}

			// // Not working
			// $(document).on('mouseover', 'a', function(event) {
			// 	console.log(jQuery(this).text())
			// 	jQuery(this).addClass("active");
			// });
			// $(document).on('mouseout', 'a', function(event) {
			// 	console.log(jQuery(this).text())
			// 	jQuery(this).removeClass("active");
			// });

			$('#card-search').on("focus", function(){
				if ($('#search-result').children().length !== 0) {
					$("#search-result").removeClass("visually-hidden");
				}
			})
			.on("focusout", function(){
				setTimeout(function() {
					$("#search-result").addClass("visually-hidden");
					if (selected_index !== -1) {
						selected_index = -1;
						set_active(selected_index)
					}
				}, 100)
			});

			$myInput.onkeydown = function(event){
				if (event.key === 'ArrowUp') {
					event.preventDefault();
					selected_index = Math.max(selected_index-1, -1);
					set_active(selected_index)
				}
				else if (event.key === 'ArrowDown') {
					event.preventDefault();
					const num_children = $('#search-result').children().length
					selected_index = Math.min(selected_index+1, num_children-1);
					set_active(selected_index)
				}
				else if (event.key === 'Enter') {
					if ($myInput.value.length >= 3) {
						const $scale = document.getElementById('scale');
						if (selected_index === -1) {
							const element = latest_data["data"][0]
							const url = element["image_uris"]["png"];
							downloadAndImport(url, element["name"] + ".png", ($scale.value || 100))
						} else {
							const element = latest_data["data"][selected_index]
							const url = element["image_uris"]["png"];
							downloadAndImport(url, element["name"] + ".png", ($scale.value || 100))
						}
					}
				else {
						clearTimeout(typing_timer);
					}
				}

				$myInput.onkeyup = function(event) {
					if (event.key === 'ArrowUp' || event.key === 'ArrowDown' || event.key === 'Enter') {} else {
						clearTimeout(typing_timer);
						typing_timer = setTimeout(update_list, 200);
					}
				}

				function update_list () {
					if ($myInput.value.length >= 3) {
						$("#search-result").empty().removeClass("visually-hidden")
						const get_call = $.get("https://api.scryfall.com/cards/search?q=" + $myInput.value);
						get_call.done(function (data) {
							console.log("https://api.scryfall.com/cards/search?q=" + $myInput.value)
							latest_data = data;
							$.each(data["data"], function (index, element) {
								$("#search-result").append("<a href='#' class='mtg-card list-group-item list-group-item-action'>" + element["name"] + "</a>")
							});
						});
					} else {
						$("#search-result").empty().addClass("visually-hidden");
					}
				}
			}

		});
	</script>
</head>

<body class="d-flex flex-column min-vh-100" onLoad="onLoaded()">
	<div class="container">
		<header class="m-2">
			<a class="text-decoration-none text-dark h1" href="javascript:history.go(0)">
				MTG Card Helper
			</a>
		</header>
		<div class="form-group w-100">
			<label class="form-label" for="card-search">Search</label>
			<input class="form-control" type="text" id="card-search" name="card-search">
		</div>
		<div class="h-100 w-100">
			<div id="search-result" class="list-group search-list overflow-scroll visually-hidden position-fixed h-100"></div>

			<div class="m-2">
				<label for="scale" class="visually-hidden">Scale</label>
				<div class="input-group mb-2 mr-sm-2">
					<div class="input-group-prepend">
						<div class="input-group-text">Scale</div>
					</div>
					<input type="text" class="form-control" id="scale" placeholder="100">
				</div>
			</div>
		</div>
		<footer class="fixed-bottom">
			<div>Created by <a href="https://github.com/Jerakin" target="_blank">Jerakin</a>
				| Powered by <a href="https://www.scryfall.com/" target="_">Scryfall</a></div>
		</footer>
	</div>
</body>
<script>
	document.body.onbeforeunload = function () {
		var csInterface 	= new CSInterface();
		var OSVersion 		= csInterface.getOSInformation();
		var appVersion 		= csInterface.hostEnvironment.appVersion;
		var versionAsFloat	= parseFloat(appVersion);

		csInterface.evalScript('$._PPP_.closeLog()');

		if (versionAsFloat < 10.3) {
			var path = "file:///Library/Application Support/Adobe/CEP/extensions/PProPanel/payloads/onbeforeunload.html";

			if (OSVersion.indexOf("Windows") >= 0) {
				path = "file:///C:/Program%20Files%20(x86)/Common%20Files/Adobe/CEP/extensions/PProPanel/payloads/onbeforeunload.html"
			}
			csInterface.openURLInDefaultBrowser(path);
		}
	};
</script>
</html>
